# vSphere snapshot 이란 ? 
스냅샷은 스냅샷을 만드는 시점의 가상 시스템 상태 및 데이터를 보관합니다. 가상 시스템의 스냅샷을 생성하면 지정된 상태의 가상 시스템 이미지가 복사되어 저장됩니다. 반복적으로 특정 가상 시스템 상태로 되돌려야 하지만 가상 시스템을 여러 개 생성하지는 않으려는 경우 스냅샷을 사용하면 편리합니다.

# vSphere Snapshot 사용 용도

아래 작업들 수행 전  스냅샷을 생성하여 필요시 이전 시점으로 복귀할 수 있는 단기 솔루션으로 유용합니다.

- 신규 소프트웨어 패치 및 설치 테스트 전 생성 : 문제시 이전 시점으로 복귀
- 주요 시스템 변경 작업 전 생성 : 작업 이슈 발생시 이전 시점으로 복귀

# vSphere snapshot 생성시 보존되는 정보
- 전원 상태 : 가상 시스템은 전원 켜짐, 전원 꺼짐 또는 일시 중단 상태일 수 있습니다.
- 디스크 상태 : 모든 가상 시스템의 가상 디스크의 상태입니다.
- (선택 사항) 메모리 상태 : 스냅샷 생성시 현재 메모리 상태까지 스냅샷으로 저장할 수 있습니다. (실행중인 VM 의 최근 상태로 복귀 가능)
> 메모리 상태 포함시 스냅샷은 메모리 상태 변경 사항을 지속적으로 저장하므로 스냅샷 파일이 과도하게 증가할 수 있어 주의가 필요합니다.

# vSphere snapshot 동작 방식
스냅샷을 만들면 연결된 각 가상 디스크나 가상 RDM에 대한 일련의 델타 디스크가 만들어져 특정 시점의 디스크 상태가 보존되며, 필요할 경우 메모리 파일이 만들어져 메모리 및 전원 상태도 보존됩니다. 

각 스냅샷마다 추가 델타 .vmdk 디스크 파일이 만들어집니다. 스냅샷을 만들 때 스냅샷 메커니즘은 게스트 운영 체제가 기본 .vmdk 파일에 쓰지 못하도록 하고 대신 모든 쓰기 작업을 델타 디스크 파일에 연결합니다. 

델타 디스크 파일은 급속히 커질 수 있으며, 게스트 운영 체제에서 가상 디스크의 모든 블록에 쓰는 경우 전체 가상 디스크만큼 커질 수도 있습니다.

# vSphere snapshot files
스냅샷 생성시 아래의 파일들이 Datastore 의 해당 가상 시스템 디렉토리내 생성이 됩니다.
스냅샷 생성 작업 시 .vmdk, -delta.vmdk, vmsd 및 vmsn 파일이 생성됩니다.

- vmname-number.vmdk 및 vmname-number-delta.vmdk
    *	가상 디스크의 현재 상태와 이전 스냅샷이 생성될 때 존재했던 상태 간의 차이를 나타내는 스냅샷 파일입니다.
    * 파일명 예시 :  S1vm-000001.vmdk 
- vmname.vmsd
    * 가상 시스템 스냅샷 정보의 데이터베이스이자 스냅샷 관리자 관련 정보의 기본 소스입니다.
- vmname.Snapshotnumber.vmsn 
    * 스냅샷을 생성하는 시점의 가상 시스템 메모리 상태입니다. 
    * 파일명 예시 : S1vm.snapshot1.vmsn 
> **참고**
.vmsn 파일은 메모리 선택에 관계없이 스냅샷을 만들 때마다 만들어집니다. 메모리가 없는 .vmsn 파일은 메모리가 있는 파일보다 휠씬 작습니다.


# Snapshot 제거
스냅샷을 삭제하면 스냅샷 트리에서 해당 스냅샷이 영구적으로 제거됩니다. 스냅샷 파일은 상위 스냅샷 디스크에 통합되어 기록되며 가상 시스템 기본 디스크와 병합됩니다. 스냅샷 트리에서 단일 스냅샷 또는 모든 스냅샷을 삭제할 수 있습니다.

스냅샷을 삭제해도 가상 시스템 또는 다른 스냅샷이 변경되지 않습니다. 스냅샷을 삭제하면 스냅샷 상태와 이전 디스크 상태 간 변경 내용이 통합됩니다. 그런 다음 삭제된 스냅샷에 대한 정보가 들어 있는 델타 디스크의 모든 데이터가 상위 디스크에 기록됩니다. 기본 상위 스냅샷을 삭제할 경우에는 모든 변경 내용이 기본 가상 시스템 디스크와 병합됩니다.

스냅샷을 삭제하려면 많은 양의 정보를 디스크에서 읽거나 디스크에 써야 합니다. 이 프로세스로 인해 통합이 완료되기 전까지 가상 시스템 성능이 낮아질 수 있습니다. 스냅샷을 통합하면 중복된 디스크가 제거되므로 가상 시스템 성능이 개선되고 스토리지 공간이 절약됩니다. 스냅샷을 삭제하고 스냅샷 파일을 통합하는 시간은 마지막 스냅샷을 만든 후 게스트 운영 체제에서 가상 디스크에 쓰는 데이터의 양에 따라 달라집니다. 가상 시스템이 켜져 있는 경우 필요한 시간은 통합 중에 가상 시스템이 쓰는 데이터의 양에 비례합니다.

# vSAN 환경에서 snapshot 파일 사이즈
vSAN 는 thin provioning 으로 구성되어 있어 vcenter UI 상에서 보여지는 크기와 실제 점유율 그리고 vsan capacity 에서 보여지는 공간의 차이는 백단으로 확인이 필요합니다. 


# references
- https://docs.vmware.com/kr/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-CA948C69-7F58-4519-AEB1-739545EA94E5.html

